<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin/Teacher Result Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #4a0e4e, #0056b3); /* Darker gradient for admin */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }
        /* Custom modal styles for alerts */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Admin/Teacher Result Management</h1>

        <!-- Login Section -->
        <div id="loginSection" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Login</h2>
            <div class="mb-4">
                <label for="loginEmail" class="block text-gray-700 text-sm font-medium mb-2">Email:</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <label for="loginPassword" class="block text-gray-700 text-sm font-medium mb-2">Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="loginBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 shadow-md">
                Login
            </button>
            <div id="loginMessage" class="mt-4 text-center text-red-600 text-sm hidden"></div>
        </div>

        <!-- Admin Panel Section -->
        <div id="adminPanel" class="hidden mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Welcome, <span id="loggedInUserEmail"></span>!</h2>
                <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
            </div>

            <!-- Class Management -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Classes</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input type="text" id="newClassInput" placeholder="New Class Name (e.g., Class 10)" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="addClassBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 shadow-md">
                        Add Class
                    </button>
                </div>
                <div id="classList" class="mt-4">
                    <h4 class="font-medium text-gray-700 mb-2">Existing Classes:</h4>
                    <ul id="classesUl" class="list-disc list-inside bg-white p-4 rounded-lg border border-gray-200">
                        <li>Loading classes...</li>
                    </ul>
                </div>
            </div>

            <!-- Student Result Management -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Student Results</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="manageClassSelect" class="block text-gray-700 text-sm font-medium mb-2">Select Class:</label>
                        <select id="manageClassSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select Class --</option>
                        </select>
                    </div>
                    <div>
                        <label for="manageRollNumberInput" class="block text-gray-700 text-sm font-medium mb-2">Roll Number:</label>
                        <input type="text" id="manageRollNumberInput" placeholder="Enter Roll Number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <button id="loadStudentBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md mb-6">
                    Load Student Result
                </button>

                <div id="studentResultForm" class="hidden bg-white p-5 rounded-lg shadow-md border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Student Details</h4>
                    <div class="mb-4">
                        <label for="studentNameInput" class="block text-gray-700 text-sm font-medium mb-2">Student Name:</label>
                        <input type="text" id="studentNameInput" placeholder="Student's Full Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-4">
                        <label for="totalMarksInput" class="block text-gray-700 text-sm font-medium mb-2">Total Marks:</label>
                        <input type="number" id="totalMarksInput" placeholder="Overall Total Marks" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div class="mb-4">
                        <label for="gradeInput" class="block text-gray-700 text-sm font-medium mb-2">Grade:</label>
                        <input type="text" id="gradeInput" placeholder="e.g., A+, B" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <h4 class="text-lg font-semibold text-gray-800 mb-4 mt-6">Subject Marks</h4>
                    <div id="subjectsContainer">
                        <!-- Subject input fields will be added here -->
                        <div class="flex gap-2 mb-2">
                            <input type="text" placeholder="Subject Name" class="subject-name flex-grow px-3 py-2 border border-gray-300 rounded-lg">
                            <input type="number" placeholder="Marks" class="subject-marks w-24 px-3 py-2 border border-gray-300 rounded-lg">
                            <button class="remove-subject-btn bg-red-400 text-white px-3 py-1 rounded-lg hover:bg-red-500 transition duration-300">X</button>
                        </div>
                    </div>
                    <button id="addSubjectBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-300 mt-4">
                        Add Subject
                    </button>

                    <div class="mt-6 flex gap-4">
                        <button id="saveResultBtn" class="flex-grow bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                            Save Result
                        </button>
                        <button id="deleteResultBtn" class="flex-grow bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md">
                            Delete Result
                        </button>
                    </div>
                    <div id="resultFormMessage" class="mt-4 text-center text-sm hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg text-gray-800"></p>
            <button id="modalCloseButton" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgufqQyVE01Di_2jzF_n641TGm8RMMisM",
            authDomain: "mzrresult.firebaseapp.com",
            projectId: "mzrresult",
            storageBucket: "mzrresult.firebasestorage.app",
            messagingSenderId: "953622456593",
            appId: "1:953622456593:web:abf64d8f3da57f57a304b0",
            measurementId: "G-K33NJ5HJBH"
        };

        // Extract appId directly from firebaseConfig
        const appId = firebaseConfig.appId;
        // initialAuthToken is not used for email/password auth, so it can be removed or set to null
        const initialAuthToken = null;

        let app, db, auth;
        let userId = null; // To store the authenticated user ID
        let isAuthReady = false; // Flag to indicate if authentication is complete

        // Get DOM elements - Login
        const loginSection = document.getElementById('loginSection');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');

        // Get DOM elements - Admin Panel
        const adminPanel = document.getElementById('adminPanel');
        const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');
        const logoutBtn = document.getElementById('logoutBtn');

        // Get DOM elements - Class Management
        const newClassInput = document.getElementById('newClassInput');
        const addClassBtn = document.getElementById('addClassBtn');
        const classesUl = document.getElementById('classesUl');

        // Get DOM elements - Student Result Management
        const manageClassSelect = document.getElementById('manageClassSelect');
        const manageRollNumberInput = document.getElementById('manageRollNumberInput');
        const loadStudentBtn = document.getElementById('loadStudentBtn');
        const studentResultForm = document.getElementById('studentResultForm');
        const studentNameInput = document.getElementById('studentNameInput');
        const totalMarksInput = document.getElementById('totalMarksInput');
        const gradeInput = document.getElementById('gradeInput');
        const subjectsContainer = document.getElementById('subjectsContainer');
        const addSubjectBtn = document.getElementById('addSubjectBtn');
        const saveResultBtn = document.getElementById('saveResultBtn');
        const deleteResultBtn = document.getElementById('deleteResultBtn');
        const resultFormMessage = document.getElementById('resultFormMessage');

        // Custom Modal elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeButton = document.querySelector('.close-button');
        const modalCloseButton = document.getElementById('modalCloseButton');

        /**
         * Displays a custom modal message instead of alert().
         * @param {string} message The message to display.
         * @param {string} type The type of message (e.g., 'error', 'success').
         */
        function showCustomModal(message, type = 'info') {
            modalMessage.textContent = message;
            customModal.style.display = 'flex'; // Use flex to center the modal content

            if (type === 'error') {
                modalMessage.style.color = '#dc2626'; // Red
            } else if (type === 'success') {
                modalMessage.style.color = '#16a34a'; // Green
            } else {
                modalMessage.style.color = '#4b5563'; // Gray
            }
        }

        // Close modal event listeners
        closeButton.onclick = function() {
            customModal.style.display = 'none';
        }
        modalCloseButton.onclick = function() {
            customModal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == customModal) {
                customModal.style.display = 'none';
            }
        }

        /**
         * Displays a message in the specified message element.
         * @param {HTMLElement} element The HTML element to display the message in.
         * @param {string} message The message text.
         * @param {string} type The type of message ('success', 'error', 'info').
         */
        function displayElementMessage(element, message, type = 'info') {
            element.textContent = message;
            element.classList.remove('hidden', 'text-red-600', 'text-green-600', 'text-blue-600');
            if (type === 'error') {
                element.classList.add('text-red-600');
            } else if (type === 'success') {
                element.classList.add('text-green-600');
            } else {
                element.classList.add('text-blue-600');
            }
            element.classList.remove('hidden');
        }

        /**
         * Hides the message in the specified message element.
         * @param {HTMLElement} element The HTML element to hide the message from.
         */
        function hideElementMessage(element) {
            element.classList.add('hidden');
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or empty. Please ensure firebaseConfig is provided.");
                    showCustomModal("Firebase is not configured. Please contact support.", "error");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loggedInUserEmailSpan.textContent = user.email;
                        loginSection.classList.add('hidden');
                        adminPanel.classList.remove('hidden');
                        isAuthReady = true;
                        loadClassesForAdmin(); // Load classes for admin panel
                        loadManageClassesDropdown(); // Load classes for result management dropdown
                    } else {
                        userId = null;
                        loginSection.classList.remove('hidden');
                        adminPanel.classList.add('hidden');
                        isAuthReady = true; // Auth state determined, ready to proceed
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showCustomModal("Failed to initialize Firebase. " + error.message, "error");
            }
        }

        /**
         * Handles user login.
         */
        async function handleLogin() {
            hideElementMessage(loginMessage);
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                displayElementMessage(loginMessage, "Please enter both email and password.", "error");
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Login error:", error);
                displayElementMessage(loginMessage, "Login failed: " + error.message, "error");
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Logout error:", error);
                showCustomModal("Logout failed: " + error.message, "error");
            }
        }

        /**
         * Adds a new class to Firestore.
         */
        async function addClass() {
            hideElementMessage(resultFormMessage);
            const newClassName = newClassInput.value.trim();
            if (!newClassName) {
                showCustomModal("Please enter a class name.", "error");
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                // Check if class already exists to avoid duplicates
                const querySnapshot = await getDocs(classesCollectionRef);
                let classExists = false;
                querySnapshot.forEach(doc => {
                    if (doc.data().name === newClassName) {
                        classExists = true;
                    }
                });

                if (classExists) {
                    showCustomModal(`Class "${newClassName}" already exists.`, "info");
                    return;
                }

                await addDoc(classesCollectionRef, { name: newClassName });
                showCustomModal(`Class "${newClassName}" added successfully!`, "success");
                newClassInput.value = ''; // Clear input
                await loadClassesForAdmin(); // Reload class list
                await loadManageClassesDropdown(); // Reload dropdown
            } catch (error) {
                console.error("Error adding class:", error);
                showCustomModal("Failed to add class: " + error.message, "error");
            }
        }

        /**
         * Loads classes for display in the admin class list.
         */
        async function loadClassesForAdmin() {
            if (!isAuthReady || !db) {
                classesUl.innerHTML = '<li>Firebase not ready.</li>';
                return;
            }
            classesUl.innerHTML = '<li>Loading classes...</li>';
            try {
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);

                if (querySnapshot.empty) {
                    classesUl.innerHTML = '<li>No classes added yet.</li>';
                    return;
                }

                let listHtml = '';
                querySnapshot.forEach(doc => {
                    listHtml += `<li class="flex justify-between items-center py-1">
                                    <span>${doc.data().name}</span>
                                    <button data-class-id="${doc.id}" class="delete-class-btn text-red-500 hover:text-red-700 ml-4">Delete</button>
                                </li>`;
                });
                classesUl.innerHTML = listHtml;

                // Attach event listeners to delete buttons
                document.querySelectorAll('.delete-class-btn').forEach(button => {
                    button.onclick = (event) => deleteClass(event.target.dataset.classId);
                });

            } catch (error) {
                console.error("Error loading classes for admin:", error);
                classesUl.innerHTML = '<li>Error loading classes.</li>';
            }
        }

        /**
         * Deletes a class from Firestore.
         * @param {string} classId The ID of the class document to delete.
         */
        async function deleteClass(classId) {
            if (!confirm("Are you sure you want to delete this class? This will also delete all student results under this class.")) {
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);
                await deleteDoc(classDocRef);
                showCustomModal("Class deleted successfully!", "success");

                // Optionally, delete all student results within this class (more complex, requires batch deletes or recursive function)
                // For simplicity, this example only deletes the class document itself.
                // A more robust solution would iterate and delete all sub-collection documents.
                // For now, assume that deleting the class document effectively "hides" its students.

                await loadClassesForAdmin(); // Reload class list
                await loadManageClassesDropdown(); // Reload dropdown
            } catch (error) {
                console.error("Error deleting class:", error);
                showCustomModal("Failed to delete class: " + error.message, "error");
            }
        }

        /**
         * Loads classes into the dropdown for managing student results.
         */
        async function loadManageClassesDropdown() {
            if (!isAuthReady || !db) {
                manageClassSelect.innerHTML = '<option value="">-- Loading Classes --</option>';
                return;
            }
            manageClassSelect.innerHTML = '<option value="">-- Loading Classes --</option>';
            try {
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);

                if (querySnapshot.empty) {
                    manageClassSelect.innerHTML = '<option value="">-- No Classes Found --</option>';
                    return;
                }

                let optionsHtml = '<option value="">-- Select Class --</option>';
                querySnapshot.forEach(doc => {
                    const classData = doc.data();
                    optionsHtml += `<option value="${doc.id}">${classData.name || doc.id}</option>`;
                });
                manageClassSelect.innerHTML = optionsHtml;

            } catch (error) {
                console.error("Error loading manage classes dropdown:", error);
                showCustomModal("Failed to load classes for management.", "error");
                manageClassSelect.innerHTML = '<option value="">-- Error Loading Classes --</option>';
            }
        }

        /**
         * Loads a student's result for editing/viewing.
         */
        async function loadStudentResult() {
            hideElementMessage(resultFormMessage);
            studentResultForm.classList.add('hidden'); // Hide form initially
            resetStudentForm(); // Clear form fields

            const selectedClassId = manageClassSelect.value;
            const rollNumber = manageRollNumberInput.value.trim();

            if (!selectedClassId || !rollNumber) {
                displayElementMessage(resultFormMessage, "Please select a class and enter a roll number.", "error");
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/classes/${selectedClassId}/students`, rollNumber);
                const studentDocSnap = await getDoc(studentDocRef);

                if (studentDocSnap.exists()) {
                    const studentData = studentDocSnap.data();
                    studentNameInput.value = studentData.studentName || '';
                    totalMarksInput.value = studentData.totalMarks || '';
                    gradeInput.value = studentData.grade || '';

                    subjectsContainer.innerHTML = ''; // Clear existing subjects
                    if (studentData.subjects && Array.isArray(studentData.subjects)) {
                        studentData.subjects.forEach(subject => {
                            addSubjectField(subject.name, subject.marks);
                        });
                    }
                    if (studentData.subjects.length === 0) { // Ensure at least one empty subject field if none exist
                        addSubjectField();
                    }
                    displayElementMessage(resultFormMessage, "Student data loaded.", "info");
                } else {
                    displayElementMessage(resultFormMessage, "No existing result found for this student. You can add a new one.", "info");
                    // Pre-fill student name if available from a separate student list, otherwise leave blank
                    addSubjectField(); // Add an empty subject field for new entry
                }
                studentResultForm.classList.remove('hidden'); // Show the form
            } catch (error) {
                console.error("Error loading student result:", error);
                showCustomModal("Failed to load student result: " + error.message, "error");
            }
        }

        /**
         * Adds a new subject input field to the form.
         * @param {string} subjectName Pre-fill subject name (optional).
         * @param {number} marks Pre-fill marks (optional).
         */
        function addSubjectField(subjectName = '', marks = '') {
            const subjectDiv = document.createElement('div');
            subjectDiv.classList.add('flex', 'gap-2', 'mb-2');
            subjectDiv.innerHTML = `
                <input type="text" placeholder="Subject Name" value="${subjectName}" class="subject-name flex-grow px-3 py-2 border border-gray-300 rounded-lg">
                <input type="number" placeholder="Marks" value="${marks}" class="subject-marks w-24 px-3 py-2 border border-gray-300 rounded-lg">
                <button class="remove-subject-btn bg-red-400 text-white px-3 py-1 rounded-lg hover:bg-red-500 transition duration-300">X</button>
            `;
            subjectsContainer.appendChild(subjectDiv);

            // Attach event listener to the new remove button
            subjectDiv.querySelector('.remove-subject-btn').onclick = () => subjectDiv.remove();
        }

        /**
         * Resets the student result form fields.
         */
        function resetStudentForm() {
            studentNameInput.value = '';
            totalMarksInput.value = '';
            gradeInput.value = '';
            subjectsContainer.innerHTML = ''; // Clear all subject fields
        }

        /**
         * Saves (creates or updates) a student's result.
         */
        async function saveStudentResult() {
            hideElementMessage(resultFormMessage);
            const selectedClassId = manageClassSelect.value;
            const rollNumber = manageRollNumberInput.value.trim();
            const studentName = studentNameInput.value.trim();
            const totalMarks = totalMarksInput.value.trim();
            const grade = gradeInput.value.trim();

            if (!selectedClassId || !rollNumber || !studentName || !totalMarks || !grade) {
                displayElementMessage(resultFormMessage, "Please fill in all student details and select a class.", "error");
                return;
            }

            const subjects = [];
            document.querySelectorAll('.subject-name').forEach((input, index) => {
                const subjectName = input.value.trim();
                const marksInput = document.querySelectorAll('.subject-marks')[index];
                const marks = marksInput ? marksInput.value.trim() : '';
                if (subjectName && marks) {
                    subjects.push({ name: subjectName, marks: parseInt(marks) });
                }
            });

            if (subjects.length === 0) {
                displayElementMessage(resultFormMessage, "Please add at least one subject with marks.", "error");
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/classes/${selectedClassId}/students`, rollNumber);
                await setDoc(studentDocRef, {
                    studentName: studentName,
                    rollNumber: rollNumber,
                    totalMarks: parseInt(totalMarks),
                    grade: grade,
                    subjects: subjects,
                    lastUpdated: new Date().toISOString()
                });
                displayElementMessage(resultFormMessage, "Student result saved successfully!", "success");
            } catch (error) {
                console.error("Error saving student result:", error);
                showCustomModal("Failed to save student result: " + error.message, "error");
            }
        }

        /**
         * Deletes a student's result.
         */
        async function deleteStudentResult() {
            hideElementMessage(resultFormMessage);
            const selectedClassId = manageClassSelect.value;
            const rollNumber = manageRollNumberInput.value.trim();

            if (!selectedClassId || !rollNumber) {
                displayElementMessage(resultFormMessage, "Please select a class and enter a roll number to delete.", "error");
                return;
            }

            if (!confirm("Are you sure you want to delete this student's result? This action cannot be undone.")) {
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/classes/${selectedClassId}/students`, rollNumber);
                await deleteDoc(studentDocRef);
                displayElementMessage(resultFormMessage, "Student result deleted successfully!", "success");
                resetStudentForm();
                studentResultForm.classList.add('hidden'); // Hide form after deletion
            } catch (error) {
                console.error("Error deleting student result:", error);
                showCustomModal("Failed to delete student result: " + error.message, "error");
            }
        }

        // Event Listeners - Login
        loginBtn.addEventListener('click', handleLogin);

        // Event Listeners - Admin Panel
        logoutBtn.addEventListener('click', handleLogout);
        addClassBtn.addEventListener('click', addClass);

        // Event Listeners - Student Result Management
        manageClassSelect.addEventListener('change', () => {
            studentResultForm.classList.add('hidden'); // Hide form when class changes
            hideElementMessage(resultFormMessage);
        });
        manageRollNumberInput.addEventListener('input', () => {
            studentResultForm.classList.add('hidden'); // Hide form when roll number changes
            hideElementMessage(resultFormMessage);
        });
        loadStudentBtn.addEventListener('click', loadStudentResult);
        addSubjectBtn.addEventListener('click', () => addSubjectField());
        saveResultBtn.addEventListener('click', saveStudentResult);
        deleteResultBtn.addEventListener('click', deleteStudentResult);

        // Initialize Firebase on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
