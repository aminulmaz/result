<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin/Teacher Result Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #4a0e4e, #0056b3); /* Darker gradient for admin */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 1200px; /* Increased max-width for better table display */
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }
        /* Custom modal styles for alerts */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Table specific styles for better readability */
        .marks-input {
            width: 60px; /* Smaller width for marks input */
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Admin/Teacher Result Management</h1>

        <!-- Login Section -->
        <div id="loginSection" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Login</h2>
            <div class="mb-4">
                <label for="loginEmail" class="block text-gray-700 text-sm font-medium mb-2">Email:</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <label for="loginPassword" class="block text-gray-700 text-sm font-medium mb-2">Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="loginBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 shadow-md">
                Login
            </button>
            <div id="loginMessage" class="mt-4 text-center text-red-600 text-sm hidden"></div>
        </div>

        <!-- Admin Panel Section -->
        <div id="adminPanel" class="hidden mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Welcome, <span id="loggedInUserEmail"></span>!</h2>
                <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
            </div>

            <!-- Class Management -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Classes</h3>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input type="text" id="newClassInput" placeholder="New Class Name (e.g., Class 10)" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="addClassBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 shadow-md">
                        Add Class
                    </button>
                </div>
                <div id="classList" class="mt-4">
                    <h4 class="font-medium text-gray-700 mb-2">Existing Classes:</h4>
                    <ul id="classesUl" class="list-disc list-inside bg-white p-4 rounded-lg border border-gray-200">
                        <li>Loading classes...</li>
                    </ul>
                </div>
            </div>

            <!-- Subject Management for Selected Class -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Subjects for Selected Class</h3>
                <div class="mb-4">
                    <label for="subjectClassSelect" class="block text-gray-700 text-sm font-medium mb-2">Select Class to Manage Subjects:</label>
                    <select id="subjectClassSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div id="subjectManagementSection" class="hidden">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input type="text" id="newSubjectInput" placeholder="New Subject Name (e.g., Physics)" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <button id="addSubjectBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md">
                            Add Subject
                        </button>
                    </div>
                    <div id="subjectList" class="mt-4">
                        <h4 class="font-medium text-gray-700 mb-2">Subjects for <span id="selectedSubjectClassName"></span>:</h4>
                        <ul id="subjectsUl" class="list-disc list-inside bg-white p-4 rounded-lg border border-gray-200">
                            <li>No subjects added yet.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Student Marks Management (Tabular) -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Student Marks</h3>

                <div class="mb-4">
                    <label for="marksClassSelect" class="block text-gray-700 text-sm font-medium mb-2">Select Class to Manage Marks:</label>
                    <select id="marksClassSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select Class --</option>
                    </select>
                </div>

                <div id="studentMarksTableSection" class="hidden">
                    <div class="flex justify-end mb-4">
                        <button id="addStudentRowBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-300">
                            Add New Student
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-blue-100 text-blue-800 uppercase text-sm leading-normal">
                                    <th class="py-3 px-4 text-left">Roll No.</th>
                                    <th class="py-3 px-4 text-left">Student Name</th>
                                    <!-- Dynamic Subject Headers will go here -->
                                    <th class="py-3 px-4 text-left">Total Marks</th>
                                    <th class="py-3 px-4 text-left">Grade</th>
                                    <th class="py-3 px-4 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentMarksTableBody" class="text-gray-700 text-sm font-light">
                                <!-- Student rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="marksTableMessage" class="mt-4 text-center text-sm hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modalMessage" class="text-lg text-gray-800"></p>
            <button id="modalCloseButton" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCgufqQyVE01Di_2jzF_n641TGm8RMMisM",
            authDomain: "mzrresult.firebaseapp.com",
            projectId: "mzrresult",
            storageBucket: "mzrresult.firebasestorage.app",
            messagingSenderId: "953622456593",
            appId: "1:953622456593:web:abf64d8f3da57f57a304b0",
            measurementId: "G-K33NJ5HJBH"
        };

        // Extract appId directly from firebaseConfig
        const appId = firebaseConfig.appId;
        const initialAuthToken = null; // Not used for email/password auth

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Global state for current class and subjects
        let currentSelectedClassId = null;
        let currentSelectedClassName = null;
        let currentSubjects = []; // Stores subject objects { id, name }

        // Get DOM elements - Login
        const loginSection = document.getElementById('loginSection');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');

        // Get DOM elements - Admin Panel
        const adminPanel = document.getElementById('adminPanel');
        const loggedInUserEmailSpan = document.getElementById('loggedInUserEmail');
        const logoutBtn = document.getElementById('logoutBtn');

        // Get DOM elements - Class Management
        const newClassInput = document.getElementById('newClassInput');
        const addClassBtn = document.getElementById('addClassBtn');
        const classesUl = document.getElementById('classesUl');

        // Get DOM elements - Subject Management
        const subjectClassSelect = document.getElementById('subjectClassSelect');
        const subjectManagementSection = document.getElementById('subjectManagementSection');
        const newSubjectInput = document.getElementById('newSubjectInput');
        const addSubjectBtn = document.getElementById('addSubjectBtn');
        const subjectList = document.getElementById('subjectList');
        const selectedSubjectClassName = document.getElementById('selectedSubjectClassName');
        const subjectsUl = document.getElementById('subjectsUl');

        // Get DOM elements - Student Marks Management
        const marksClassSelect = document.getElementById('marksClassSelect');
        const studentMarksTableSection = document.getElementById('studentMarksTableSection');
        const addStudentRowBtn = document.getElementById('addStudentRowBtn');
        const studentMarksTableBody = document.getElementById('studentMarksTableBody');
        const marksTableMessage = document.getElementById('marksTableMessage');

        // Custom Modal elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeButton = document.querySelector('.close-button');
        const modalCloseButton = document.getElementById('modalCloseButton');

        /**
         * Displays a custom modal message instead of alert().
         * @param {string} message The message to display.
         * @param {string} type The type of message (e.g., 'error', 'success').
         */
        function showCustomModal(message, type = 'info') {
            modalMessage.textContent = message;
            customModal.style.display = 'flex';

            if (type === 'error') {
                modalMessage.style.color = '#dc2626';
            } else if (type === 'success') {
                modalMessage.style.color = '#16a34a';
            } else {
                modalMessage.style.color = '#4b5563';
            }
        }

        // Close modal event listeners
        closeButton.onclick = function() {
            customModal.style.display = 'none';
        }
        modalCloseButton.onclick = function() {
            customModal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == customModal) {
                customModal.style.display = 'none';
            }
        }

        /**
         * Displays a message in the specified message element.
         * @param {HTMLElement} element The HTML element to display the message in.
         * @param {string} message The message text.
         * @param {string} type The type of message ('success', 'error', 'info').
         */
        function displayElementMessage(element, message, type = 'info') {
            element.textContent = message;
            element.classList.remove('hidden', 'text-red-600', 'text-green-600', 'text-blue-600');
            if (type === 'error') {
                element.classList.add('text-red-600');
            } else if (type === 'success') {
                element.classList.add('text-green-600');
            } else {
                element.classList.add('text-blue-600');
            }
            element.classList.remove('hidden');
        }

        /**
         * Hides the message in the specified message element.
         * @param {HTMLElement} element The HTML element to hide the message from.
         */
        function hideElementMessage(element) {
            element.classList.add('hidden');
        }

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or empty. Please ensure firebaseConfig is provided.");
                    showCustomModal("Firebase is not configured. Please contact support.", "error");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loggedInUserEmailSpan.textContent = user.email;
                        loginSection.classList.add('hidden');
                        adminPanel.classList.remove('hidden');
                        isAuthReady = true;
                        loadClassesForAdmin(); // Load classes for admin panel
                        loadAllClassDropdowns(); // Load classes for all dropdowns
                    } else {
                        userId = null;
                        loginSection.classList.remove('hidden');
                        adminPanel.classList.add('hidden');
                        isAuthReady = true;
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showCustomModal("Failed to initialize Firebase. " + error.message, "error");
            }
        }

        /**
         * Handles user login.
         */
        async function handleLogin() {
            hideElementMessage(loginMessage);
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                displayElementMessage(loginMessage, "Please enter both email and password.", "error");
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error);
                displayElementMessage(loginMessage, "Login failed: " + error.message, "error");
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showCustomModal("Logout failed: " + error.message, "error");
            }
        }

        /**
         * Adds a new class to Firestore.
         */
        async function addClass() {
            const newClassName = newClassInput.value.trim();
            if (!newClassName) {
                showCustomModal("Please enter a class name.", "error");
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);
                let classExists = false;
                querySnapshot.forEach(doc => {
                    if (doc.data().name === newClassName) {
                        classExists = true;
                    }
                });

                if (classExists) {
                    showCustomModal(`Class "${newClassName}" already exists.`, "info");
                    return;
                }

                await addDoc(classesCollectionRef, { name: newClassName });
                showCustomModal(`Class "${newClassName}" added successfully!`, "success");
                newClassInput.value = '';
                await loadClassesForAdmin();
                await loadAllClassDropdowns();
            } catch (error) {
                console.error("Error adding class:", error);
                showCustomModal("Failed to add class: " + error.message, "error");
            }
        }

        /**
         * Loads classes for display in the admin class list.
         */
        async function loadClassesForAdmin() {
            if (!isAuthReady || !db) {
                classesUl.innerHTML = '<li>Firebase not ready.</li>';
                return;
            }
            classesUl.innerHTML = '<li>Loading classes...</li>';
            try {
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);

                if (querySnapshot.empty) {
                    classesUl.innerHTML = '<li>No classes added yet.</li>';
                    return;
                }

                let listHtml = '';
                querySnapshot.forEach(doc => {
                    listHtml += `<li class="flex justify-between items-center py-1">
                                    <span>${doc.data().name}</span>
                                    <button data-class-id="${doc.id}" class="delete-class-btn text-red-500 hover:text-red-700 ml-4">Delete</button>
                                </li>`;
                });
                classesUl.innerHTML = listHtml;

                document.querySelectorAll('.delete-class-btn').forEach(button => {
                    button.onclick = (event) => deleteClass(event.target.dataset.classId);
                });

            } catch (error) {
                console.error("Error loading classes for admin:", error);
                classesUl.innerHTML = '<li>Error loading classes.</li>';
            }
        }

        /**
         * Deletes a class from Firestore.
         * @param {string} classId The ID of the class document to delete.
         */
        async function deleteClass(classId) {
            if (!confirm("Are you sure you want to delete this class? This will also delete all associated subjects and student results.")) {
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, classId);

                // Delete all subjects for this class
                const subjectsCollectionRef = collection(db, `artifacts/${appId}/public/data/classes/${classId}/subjects`);
                const subjectDocs = await getDocs(subjectsCollectionRef);
                const deleteSubjectPromises = [];
                subjectDocs.forEach(sDoc => {
                    deleteSubjectPromises.push(deleteDoc(doc(db, `artifacts/${appId}/public/data/classes/${classId}/subjects`, sDoc.id)));
                });
                await Promise.all(deleteSubjectPromises);

                // Delete all students for this class
                const studentsCollectionRef = collection(db, `artifacts/${appId}/public/data/classes/${classId}/students`);
                const studentDocs = await getDocs(studentsCollectionRef);
                const deleteStudentPromises = [];
                studentDocs.forEach(stDoc => {
                    deleteStudentPromises.push(deleteDoc(doc(db, `artifacts/${appId}/public/data/classes/${classId}/students`, stDoc.id)));
                });
                await Promise.all(deleteStudentPromises);

                // Finally, delete the class document itself
                await deleteDoc(classDocRef);

                showCustomModal("Class and all associated data deleted successfully!", "success");
                await loadClassesForAdmin();
                await loadAllClassDropdowns();
                // Reset relevant sections
                subjectManagementSection.classList.add('hidden');
                studentMarksTableSection.classList.add('hidden');
            } catch (error) {
                console.error("Error deleting class:", error);
                showCustomModal("Failed to delete class: " + error.message, "error");
            }
        }

        /**
         * Loads classes into all relevant dropdowns.
         */
        async function loadAllClassDropdowns() {
            if (!isAuthReady || !db) {
                subjectClassSelect.innerHTML = '<option value="">-- Loading Classes --</option>';
                marksClassSelect.innerHTML = '<option value="">-- Loading Classes --</option>';
                return;
            }

            try {
                const classesCollectionRef = collection(db, `artifacts/${appId}/public/data/classes`);
                const querySnapshot = await getDocs(classesCollectionRef);

                let optionsHtml = '<option value="">-- Select Class --</option>';
                if (querySnapshot.empty) {
                    optionsHtml = '<option value="">-- No Classes Found --</option>';
                } else {
                    querySnapshot.forEach(doc => {
                        const classData = doc.data();
                        optionsHtml += `<option value="${doc.id}">${classData.name || doc.id}</option>`;
                    });
                }
                subjectClassSelect.innerHTML = optionsHtml;
                marksClassSelect.innerHTML = optionsHtml;

            } catch (error) {
                console.error("Error loading class dropdowns:", error);
                showCustomModal("Failed to load classes for dropdowns.", "error");
                subjectClassSelect.innerHTML = '<option value="">-- Error Loading Classes --</option>';
                marksClassSelect.innerHTML = '<option value="">-- Error Loading Classes --</option>';
            }
        }

        /**
         * Handles class selection for subject management.
         */
        async function handleSubjectClassSelect() {
            currentSelectedClassId = subjectClassSelect.value;
            currentSelectedClassName = subjectClassSelect.options[subjectClassSelect.selectedIndex].text;

            if (currentSelectedClassId) {
                selectedSubjectClassName.textContent = currentSelectedClassName;
                subjectManagementSection.classList.remove('hidden');
                await loadSubjectsForClass(currentSelectedClassId);
            } else {
                subjectManagementSection.classList.add('hidden');
                subjectsUl.innerHTML = '<li>No class selected.</li>';
            }
        }

        /**
         * Loads subjects for a specific class.
         * @param {string} classId The ID of the class.
         */
        async function loadSubjectsForClass(classId) {
            if (!isAuthReady || !db || !classId) {
                subjectsUl.innerHTML = '<li>Firebase not ready or no class selected.</li>';
                return;
            }
            subjectsUl.innerHTML = '<li>Loading subjects...</li>';
            currentSubjects = []; // Clear previous subjects

            try {
                const subjectsCollectionRef = collection(db, `artifacts/${appId}/public/data/classes/${classId}/subjects`);
                const querySnapshot = await getDocs(subjectsCollectionRef);

                if (querySnapshot.empty) {
                    subjectsUl.innerHTML = '<li>No subjects added for this class.</li>';
                    return;
                }

                let listHtml = '';
                querySnapshot.forEach(doc => {
                    const subjectData = doc.data();
                    currentSubjects.push({ id: doc.id, name: subjectData.name });
                    listHtml += `<li class="flex justify-between items-center py-1">
                                    <span>${subjectData.name}</span>
                                    <button data-subject-id="${doc.id}" class="delete-subject-btn text-red-500 hover:text-red-700 ml-4">Delete</button>
                                </li>`;
                });
                subjectsUl.innerHTML = listHtml;

                document.querySelectorAll('.delete-subject-btn').forEach(button => {
                    button.onclick = (event) => deleteSubject(classId, event.target.dataset.subjectId);
                });

            } catch (error) {
                console.error("Error loading subjects:", error);
                subjectsUl.innerHTML = '<li>Error loading subjects.</li>';
            }
        }

        /**
         * Adds a new subject to the selected class.
         */
        async function addSubject() {
            const subjectName = newSubjectInput.value.trim();
            if (!subjectName) {
                showCustomModal("Please enter a subject name.", "error");
                return;
            }
            if (!currentSelectedClassId) {
                showCustomModal("Please select a class first.", "error");
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const subjectsCollectionRef = collection(db, `artifacts/${appId}/public/data/classes/${currentSelectedClassId}/subjects`);
                const querySnapshot = await getDocs(subjectsCollectionRef);
                let subjectExists = false;
                querySnapshot.forEach(doc => {
                    if (doc.data().name === subjectName) {
                        subjectExists = true;
                    }
                });

                if (subjectExists) {
                    showCustomModal(`Subject "${subjectName}" already exists for this class.`, "info");
                    return;
                }

                await addDoc(subjectsCollectionRef, { name: subjectName });
                showCustomModal(`Subject "${subjectName}" added successfully!`, "success");
                newSubjectInput.value = '';
                await loadSubjectsForClass(currentSelectedClassId);
                await loadStudentsAndMarks(currentSelectedClassId); // Reload student table to update columns
            } catch (error) {
                console.error("Error adding subject:", error);
                showCustomModal("Failed to add subject: " + error.message, "error");
            }
        }

        /**
         * Deletes a subject from the selected class.
         * @param {string} classId The ID of the class.
         * @param {string} subjectId The ID of the subject document to delete.
         */
        async function deleteSubject(classId, subjectId) {
            if (!confirm("Are you sure you want to delete this subject? This will remove it from all students' results in this class.")) {
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const subjectDocRef = doc(db, `artifacts/${appId}/public/data/classes/${classId}/subjects`, subjectId);
                await deleteDoc(subjectDocRef);
                showCustomModal("Subject deleted successfully!", "success");
                await loadSubjectsForClass(classId);
                await loadStudentsAndMarks(classId); // Reload student table to update columns
            } catch (error) {
                console.error("Error deleting subject:", error);
                showCustomModal("Failed to delete subject: " + error.message, "error");
            }
        }

        /**
         * Handles class selection for marks management.
         */
        async function handleMarksClassSelect() {
            currentSelectedClassId = marksClassSelect.value;
            currentSelectedClassName = marksClassSelect.options[marksClassSelect.selectedIndex].text;

            if (currentSelectedClassId) {
                studentMarksTableSection.classList.remove('hidden');
                await loadSubjectsForClass(currentSelectedClassId); // Ensure subjects are loaded for column generation
                await loadStudentsAndMarks(currentSelectedClassId);
            } else {
                studentMarksTableSection.classList.add('hidden');
                studentMarksTableBody.innerHTML = ''; // Clear table
                document.querySelector('#studentMarksTableSection thead tr').innerHTML = `
                    <th class="py-3 px-4 text-left">Roll No.</th>
                    <th class="py-3 px-4 text-left">Student Name</th>
                    <th class="py-3 px-4 text-left">Total Marks</th>
                    <th class="py-3 px-4 text-left">Grade</th>
                    <th class="py-3 px-4 text-left">Actions</th>
                `;
            }
        }

        /**
         * Loads students and their marks for the selected class into a tabular structure.
         * Dynamically generates subject columns.
         */
        async function loadStudentsAndMarks(classId) {
            if (!isAuthReady || !db || !classId) {
                studentMarksTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Firebase not ready or no class selected.</td></tr>';
                return;
            }

            hideElementMessage(marksTableMessage);
            studentMarksTableBody.innerHTML = '<tr><td colspan="100%" class="text-center py-4">Loading student data...</td></tr>'; // Use 100% for colspan

            try {
                // Ensure subjects are loaded first to build dynamic columns
                await loadSubjectsForClass(classId); // This will populate currentSubjects global variable

                // Build table header dynamically
                const tableHeaderRow = document.querySelector('#studentMarksTableSection thead tr');
                tableHeaderRow.innerHTML = `
                    <th class="py-3 px-4 text-left">Roll No.</th>
                    <th class="py-3 px-4 text-left">Student Name</th>
                `;
                currentSubjects.forEach(subject => {
                    tableHeaderRow.innerHTML += `<th class="py-3 px-4 text-left">${subject.name}</th>`;
                });
                tableHeaderRow.innerHTML += `
                    <th class="py-3 px-4 text-left">Total Marks</th>
                    <th class="py-3 px-4 text-left">Grade</th>
                    <th class="py-3 px-4 text-left">Actions</th>
                `;

                const studentsCollectionRef = collection(db, `artifacts/${appId}/public/data/classes/${classId}/students`);
                const querySnapshot = await getDocs(studentsCollectionRef);

                studentMarksTableBody.innerHTML = ''; // Clear existing rows

                if (querySnapshot.empty) {
                    studentMarksTableBody.innerHTML = `<tr><td colspan="${4 + currentSubjects.length}" class="text-center py-4">No students added for this class yet. Click "Add New Student" to begin.</td></tr>`;
                    return;
                }

                querySnapshot.forEach(doc => {
                    const studentData = doc.data();
                    addStudentRowToTable(studentData, false); // Add existing student, not a new empty row
                });

            } catch (error) {
                console.error("Error loading students and marks:", error);
                displayElementMessage(marksTableMessage, "Failed to load student marks: " + error.message, "error");
                studentMarksTableBody.innerHTML = `<tr><td colspan="${4 + currentSubjects.length}" class="text-center py-4 text-red-600">Error loading student data.</td></tr>`;
            }
        }

        /**
         * Adds a student row to the table.
         * @param {Object} studentData The student data object.
         * @param {boolean} isNewRow True if this is a newly added empty row.
         */
        function addStudentRowToTable(studentData = {}, isNewRow = true) {
            const row = document.createElement('tr');
            row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-100');
            row.dataset.rollNumber = studentData.rollNumber || ''; // Store roll number for easy access

            let subjectMarksHtml = '';
            currentSubjects.forEach(subject => {
                const marks = studentData.subjects ? (studentData.subjects.find(s => s.name === subject.name)?.marks || '') : '';
                subjectMarksHtml += `<td class="py-2 px-4"><input type="number" class="w-full border rounded-md px-2 py-1 marks-input" data-subject-name="${subject.name}" value="${marks}" placeholder="-" min="0" max="100"></td>`;
            });

            row.innerHTML = `
                <td class="py-2 px-4">
                    <input type="text" class="w-full border rounded-md px-2 py-1 roll-number-input" value="${studentData.rollNumber || ''}" placeholder="Roll No." ${isNewRow ? '' : 'readonly'}>
                </td>
                <td class="py-2 px-4">
                    <input type="text" class="w-full border rounded-md px-2 py-1 student-name-input" value="${studentData.studentName || ''}" placeholder="Student Name">
                </td>
                ${subjectMarksHtml}
                <td class="py-2 px-4">
                    <input type="number" class="w-full border rounded-md px-2 py-1 total-marks-input" value="${studentData.totalMarks || ''}" placeholder="Total" readonly>
                </td>
                <td class="py-2 px-4">
                    <input type="text" class="w-full border rounded-md px-2 py-1 grade-input" value="${studentData.grade || ''}" placeholder="Grade">
                </td>
                <td class="py-2 px-4 flex gap-2">
                    <button class="save-student-btn bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition duration-300">Save</button>
                    <button class="delete-student-btn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-300">Delete</button>
                </td>
            `;

            studentMarksTableBody.appendChild(row);

            // Attach event listeners to the new row's buttons
            row.querySelector('.save-student-btn').onclick = () => saveStudentRow(row);
            row.querySelector('.delete-student-btn').onclick = () => deleteStudentRow(row);

            // Add input event listener for marks to calculate total
            row.querySelectorAll('.marks-input').forEach(input => {
                input.addEventListener('input', () => calculateTotalMarks(row));
            });
        }

        /**
         * Calculates and updates the total marks for a student row.
         * @param {HTMLElement} row The table row element.
         */
        function calculateTotalMarks(row) {
            let total = 0;
            row.querySelectorAll('.marks-input').forEach(input => {
                const marks = parseInt(input.value) || 0;
                total += marks;
            });
            row.querySelector('.total-marks-input').value = total;
        }

        /**
         * Saves (creates or updates) a student's result from a table row.
         * @param {HTMLElement} row The table row element.
         */
        async function saveStudentRow(row) {
            hideElementMessage(marksTableMessage);
            const classId = marksClassSelect.value;
            const rollNumberInput = row.querySelector('.roll-number-input');
            const studentNameInput = row.querySelector('.student-name-input');
            const totalMarksInput = row.querySelector('.total-marks-input');
            const gradeInput = row.querySelector('.grade-input');

            const rollNumber = rollNumberInput.value.trim();
            const studentName = studentNameInput.value.trim();
            const totalMarks = totalMarksInput.value.trim();
            const grade = gradeInput.value.trim();

            if (!classId || !rollNumber || !studentName || !totalMarks || !grade) {
                displayElementMessage(marksTableMessage, "Please fill in all required fields (Roll No., Name, Total Marks, Grade) for the student.", "error");
                return;
            }

            const subjects = [];
            let allMarksEntered = true;
            row.querySelectorAll('.marks-input').forEach(input => {
                const subjectName = input.dataset.subjectName;
                const marks = input.value.trim();
                if (marks === '') { // Check if marks are empty for any subject
                    allMarksEntered = false;
                }
                subjects.push({ name: subjectName, marks: parseInt(marks) || 0 }); // Store 0 if empty
            });

            if (!allMarksEntered) {
                displayElementMessage(marksTableMessage, "Please enter marks for all subjects or leave them as 0 if not applicable.", "error");
                // return; // Allow saving with empty marks if needed, but warn
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/classes/${classId}/students`, rollNumber);
                await setDoc(studentDocRef, {
                    studentName: studentName,
                    rollNumber: rollNumber,
                    totalMarks: parseInt(totalMarks),
                    grade: grade,
                    subjects: subjects,
                    lastUpdated: new Date().toISOString()
                });
                displayElementMessage(marksTableMessage, `Student ${studentName} (Roll No: ${rollNumber}) saved successfully!`, "success");
                rollNumberInput.readOnly = true; // Make roll number read-only after saving
                row.dataset.rollNumber = rollNumber; // Update dataset if it was a new row
            } catch (error) {
                console.error("Error saving student result:", error);
                showCustomModal("Failed to save student result: " + error.message, "error");
            }
        }

        /**
         * Deletes a student's result from a table row.
         * @param {HTMLElement} row The table row element.
         */
        async function deleteStudentRow(row) {
            hideElementMessage(marksTableMessage);
            const classId = marksClassSelect.value;
            const rollNumber = row.dataset.rollNumber; // Get roll number from dataset

            if (!classId || !rollNumber) {
                displayElementMessage(marksTableMessage, "Cannot delete: Class or Roll Number missing.", "error");
                return;
            }

            if (!confirm(`Are you sure you want to delete result for Roll No: ${rollNumber}? This action cannot be undone.`)) {
                return;
            }

            if (!isAuthReady || !db) {
                showCustomModal("Firebase is not ready. Please wait.", "error");
                return;
            }

            try {
                const studentDocRef = doc(db, `artifacts/${appId}/public/data/classes/${classId}/students`, rollNumber);
                await deleteDoc(studentDocRef);
                displayElementMessage(marksTableMessage, `Student result for Roll No: ${rollNumber} deleted successfully!`, "success");
                row.remove(); // Remove the row from the table
                // If the table becomes empty, show a message
                if (studentMarksTableBody.children.length === 0) {
                    studentMarksTableBody.innerHTML = `<tr><td colspan="${4 + currentSubjects.length}" class="text-center py-4">No students added for this class yet. Click "Add New Student" to begin.</td></tr>`;
                }
            } catch (error) {
                console.error("Error deleting student result:", error);
                showCustomModal("Failed to delete student result: " + error.message, "error");
            }
        }

        // Event Listeners - Login
        loginBtn.addEventListener('click', handleLogin);

        // Event Listeners - Admin Panel
        logoutBtn.addEventListener('click', handleLogout);
        addClassBtn.addEventListener('click', addClass);

        // Event Listeners - Subject Management
        subjectClassSelect.addEventListener('change', handleSubjectClassSelect);
        addSubjectBtn.addEventListener('click', addSubject);

        // Event Listeners - Student Marks Management
        marksClassSelect.addEventListener('change', handleMarksClassSelect);
        addStudentRowBtn.addEventListener('click', () => addStudentRowToTable({}, true)); // Add an empty row for new student

        // Initialize Firebase on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
